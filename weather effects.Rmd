---
title: "Weather Events and Human Health"
author: "Neil Hepburn"
date: "January 15, 2016"
output: html_document
---
# Notes

- To clean up the explanatory codes for crop damage and property damage, begin by loading Hmisc and then use %nin% to drop observations with weird codes. Next, c

# Synopsis

# Data Processing

```{r, echo=TRUE, message=FALSE}

# check for existence of data source file in working directory
if(!file.exists("stormdata.csv.bz2")){download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2","stormdata.csv.bz2")}

# determine if the data file needs to be read in or if a data.frame exists within the workspace already.
if(!exists("stormdata")){
      stormdata <- read.csv("stormdata.csv.bz2",header = TRUE)
}


# identify the data
names(stormdata)

# create properly formatted begin dates and then year
stormdata$BGN_DATE <- as.Date(as.character(stormdata$BGN_DATE),"%m/%d/%Y")
stormdata$year <- as.numeric(format(stormdata$BGN_DATE,"%Y"))
```

Producing a summary table of the variable 'EVTYPE' immediately indicates a serious problem. Many of the event types show up in multiple forms. For example, events dealing with thunderstorms and wind show up as three different event types with three different (mis)spellings: THUDERSTORM WINDS, THUNDEERSTORM WINDS, and THUNDERSTORM WINDS. Clearly, extensive data cleansing is needed. In addition, there are some summary entries in the data that could skew other results so these will need to be removed.

The first step in dealing with this is removing all of the summaries that are included in the data set. Next, a table of the official weather categories was created from documentation from NOAA and the stringdist package was used to clean up the EVTYPE variable and deal with the spelling errors in the EVTYPE variable. One event type that occurs in the original data set but appears to have no similar category in the official NOAA definitions is "TSTM". After an internet search, I have discovered that this event is marine thunderstorm wind event.

```{r,echo=TRUE,message=TRUE}

# first eliminate the rows with "summary" in EVTYPE
stormdata$EVTYPE <- toupper(stormdata$EVTYPE)
stormdata <-subset(stormdata,!grepl("SUMMARY",stormdata$EVTYPE))

# replace the TSTM with MARINE THUNDERSTORM so that it can be matched with amatch()
stormdata$EVTYPE<-gsub("TSTM","MARINE THUNDERSTORM",stormdata$EVTYPE)

# read in the categories from an externally generated file.
categories <- read.csv("categories.csv")
categories$EventName<-toupper(categories$EventName)

# now use amatch() to clean up misspelled event types.
library(stringdist)
stormdata$EVTYPE.cor <- categories[amatch(stormdata$EVTYPE,categories$EventName,method="soundex",maxDist = 120),"EventName"]
```

Another problem that arises is that in the dataset provided, there is a category called "landslide". However, this does not correspond to any such category in the NOAA list of categories. There are a couple of ways to treat this category. One possibility is to assume that each landslide was caused by heavy rain and recode them as heavy rain. The other possibility is to treat landslides as a distinct category. Due to the policy implications insofar as planning and public policy is concerned, I am treating landslides as a separate category, albeit one not in the official NOAA list of weather events.

```{r,echo=TRUE,message=FALSE}
stormdata$EVTYPE.cor[grepl("LANDSLIDE",stormdata$EVTYPE)]<-"LANDSLIDE"
```

## Adjusting Monetary Values for Inflation

The dollar figures for damages are reported in current values. To make any sense of these numbers over time we need to convert them to real (inflation adjusted) values. To do this, CPI figures have been retrieved from the Bureau of Labour Statistics and are used for the conversion. The data was retrieved from the Federal Reserve Bank of St. Louis (https://research.stlouisfed.org/fred2/series/GDPDEF/downloaddata.). The basic formula for this conversion is 
\[
\text{Real Value}=\frac{\text{Nominal Value}}{\text{Price Level}}\times 100
\]
```{r,inflation_adjustment,echo=TRUE,message=FALSE}

# read in the CPI data. Series information is contained in the first 53 rows of the spreadsheet
library(xlsx)
PriceLevel <- read.xlsx("GDPDEF.xls",sheetIndex = 1,startRow =17)

# Pull out the year to use for matching with storm data
PriceLevel$year <- substr(PriceLevel$DATE,0,4)

# restrict PriceLevel data to time frame of storm data
PriceLevel <- subset(PriceLevel,PriceLevel$year %in% 1950:2011)
pricelevel <- PriceLevel$VALUE
names(pricelevel) <- PriceLevel$year

# now add price level data to stormdata table
stormdata$pricelevel <- pricelevel[as.character(stormdata$year)]
stormdata$PROPDMG.real <- with(stormdata,100*PROPDMG/pricelevel)
stormdata$CROPDMG.real <- with(stormdata,100*CROPDMG/pricelevel)
```


## PROPDMGexp and CROPDMGexp

These two variables have some significant coding problems. They should take on values of K (1000s), M (millions) or B (billions). However, there are several other codes for which no sensible interpretation can be made. These will be dropped from the dataset.
```{r,echo=TRUE,message=FALSE}

# need to address problems with incorrectly coded PROPDMGexp and CROPDMGexp. 
library(Hmisc)
stormdata <- subset(stormdata, stormdata$PROPDMGEXP %nin% c("-", "?", "+", "0" ,"1" ,"2" ,"3", "4" ,"5", "6" ,"7", "8","h","H"))
stormdata$PROPDMGEXP[stormdata$PROPDMGEXP=="m"]<-"M"
stormdata$PROPDMGEXP <- factor(stormdata$PROPDMGEXP)
multiples <- c(1000,1000000,1000000000)
names(multiples)<-c("K","M","B")
stormdata$multiples <- multiples[as.character(stormdata$PROPDMGEXP)]
stormdata$PROPDMG.real <- with(stormdata,PROPDMG*100/Pr)
```


# Results

## Event Types and Population Health 

The variable 'EVTYPE' indicates the type of weather event. Is there a difference in the human costs related to different weather events? 

```{r,echo=TRUE,message=FALSE}
evtype.totals <- stormdata %>%
      group_by(EVTYPE.cor,year) %>%
      summarise(deaths=sum(FATALITIES,na.rm=TRUE),injuries=sum(INJURIES,na.rm=TRUE))

maxinjuries <- evtype.totals[evtype.totals$injuries==max(evtype.totals$injuries),c("EVTYPE.cor","year","injuries")]
maxfatalities <- evtype.totals[evtype.totals$deaths==max(evtype.totals$deaths),c("EVTYPE.cor","year","deaths")]
```
In terms of fatalities, the worst event type was `r tolower(maxfatalities$EVTYPE.cor)` in `r maxfatalities$year` with a total of `r maxfatalities$deaths` deaths. In terms of injuries, the worst event type was `r tolower(maxinjuries$EVTYPE.cor)` in `r maxinjuries$year` with a total of `r maxinjuries$injuries` injuries.

```{r,echo=TRUE,message=FALSE}
stormdata <- subset(stormdata,!is.na(stormdata$EVTYPE.cor))
evtype.averages <- stormdata %>%
      group_by(EVTYPE.cor) %>%
      summarise(avg.injuries=mean(INJURIES,na.rm=TRUE),avg.deaths=mean(FATALITIES,na.rm=TRUE))
evtype.averages
```
Over the entire time period in the data set, the average 

## Economic Consequences

